generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ══════════════════════════════════════════════════════════════
// Multi-Tenancy
// ══════════════════════════════════════════════════════════════

model Organization {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique
  plan      Plan      @default(FREE)
  status    OrgStatus @default(ACTIVE)
  settings  Json?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  users         User[]
  personas      Persona[]
  channels      Channel[]
  kbCollections KBCollection[]
  conversations Conversation[]
  contacts      ExternalContact[]

  @@map("organizations")
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  CANCELED
}

// ══════════════════════════════════════════════════════════════
// Users & Auth
// ══════════════════════════════════════════════════════════════

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(MEMBER)
  orgId     String   @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id])
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  refreshTokens RefreshToken[]

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  OWNER
  ADMIN
  MEMBER
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}

// ══════════════════════════════════════════════════════════════
// Personas
// ══════════════════════════════════════════════════════════════

model Persona {
  id           String  @id @default(uuid())
  orgId        String  @map("org_id")
  org          Organization @relation(fields: [orgId], references: [id])
  name         String
  description  String?
  systemPrompt String  @map("system_prompt") @db.Text
  model        String  @default("gpt-4o-mini")
  temperature  Float   @default(0.3)
  voiceEnabled Boolean @default(true) @map("voice_enabled")
  voiceUuid    String? @map("voice_uuid")
  avatar       String?
  isActive     Boolean @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  channels      ChannelPersona[]
  kbCollections PersonaKB[]
  conversations Conversation[]
  tools         PersonaTool[]

  @@map("personas")
}

// ══════════════════════════════════════════════════════════════
// Persona Tools (Function Calling)
// ══════════════════════════════════════════════════════════════

model PersonaTool {
  id        String   @id @default(uuid())
  personaId String   @map("persona_id")
  persona   Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  toolType  ToolType @map("tool_type")
  config    Json?
  isEnabled Boolean  @default(true) @map("is_enabled")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([personaId, toolType])
  @@map("persona_tools")
}

enum ToolType {
  STRIPE_CHECK_PAYMENT
  STRIPE_SEND_PAYMENT_LINK
  TRIBUNAIS_SEARCH
  LEGISLACAO_SEARCH
}

// ══════════════════════════════════════════════════════════════
// Channels
// ══════════════════════════════════════════════════════════════

model Channel {
  id        String      @id @default(uuid())
  orgId     String      @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id])
  type      ChannelType
  name      String
  token     String      @unique @default(uuid())
  config    Json?
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  personas      ChannelPersona[]
  conversations Conversation[]

  @@map("channels")
}

enum ChannelType {
  WHATSAPP
  WEBCHAT
  EMAIL
}

model ChannelPersona {
  id        String  @id @default(uuid())
  channelId String  @map("channel_id")
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  personaId String  @map("persona_id")
  persona   Persona @relation(fields: [personaId], references: [id], onDelete: Cascade)
  isDefault Boolean @default(false) @map("is_default")

  @@unique([channelId, personaId])
  @@map("channel_personas")
}

// ══════════════════════════════════════════════════════════════
// Knowledge Base
// ══════════════════════════════════════════════════════════════

model KBCollection {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id])
  name      String
  description String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  documents KBDocument[]
  personas  PersonaKB[]

  @@map("kb_collections")
}

model PersonaKB {
  id           String       @id @default(uuid())
  personaId    String       @map("persona_id")
  persona      Persona      @relation(fields: [personaId], references: [id], onDelete: Cascade)
  collectionId String       @map("collection_id")
  collection   KBCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([personaId, collectionId])
  @@map("persona_kb")
}

model KBDocument {
  id           String       @id @default(uuid())
  collectionId String       @map("collection_id")
  collection   KBCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  title        String
  content      String       @db.Text
  source       String?
  metadata     Json?
  createdAt    DateTime     @default(now()) @map("created_at")

  chunks KBChunk[]

  @@map("kb_documents")
}

model KBChunk {
  id         String   @id @default(uuid())
  documentId String   @map("document_id")
  document   KBDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  content    String   @db.Text
  embedding  Unsupported("vector(1536)")
  chunkIndex Int      @map("chunk_index")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("kb_chunks")
}

// ══════════════════════════════════════════════════════════════
// Conversations & Messages
// ══════════════════════════════════════════════════════════════

model Conversation {
  id        String     @id @default(uuid())
  orgId     String     @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id])
  personaId String     @map("persona_id")
  persona   Persona    @relation(fields: [personaId], references: [id])
  channelId String?    @map("channel_id")
  channel   Channel?   @relation(fields: [channelId], references: [id])
  contactId String?    @map("contact_id")
  contact   ExternalContact? @relation(fields: [contactId], references: [id])
  sessionId String?    @map("session_id")
  status    ConvStatus @default(ACTIVE)
  metadata  Json?
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  messages Message[]

  @@map("conversations")
}

enum ConvStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  content        String       @db.Text
  sources        Json?
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at")

  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ══════════════════════════════════════════════════════════════
// External Contacts
// ══════════════════════════════════════════════════════════════

model ExternalContact {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  org       Organization @relation(fields: [orgId], references: [id])
  phone     String?
  email     String?
  name      String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  conversations Conversation[]

  @@unique([orgId, phone])
  @@unique([orgId, email])
  @@map("external_contacts")
}
